<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>MQTT Debug - GrowHub</title>
<link rel="icon" type="image/svg+xml" href="favicon-plant.svg">
<style>
:root{--clr-neon:hsl(288,52%,35%);--clr-bg:hsl(295,14%,67%)}
*{margin:0;padding:0;box-sizing:border-box}
body{background:#000;color:#fff;font-family:'Courier New',monospace;padding:15px}
h1{text-align:center;color:#c900cc;margin-bottom:20px;font-size:24px}
.section{background:#1a001a;border:2px solid var(--clr-neon);border-radius:10px;padding:15px;margin-bottom:15px}
.section h2{color:#c900cc;font-size:18px;margin-bottom:10px}
.log{background:#000;border:1px solid #500078;border-radius:5px;padding:10px;max-height:300px;overflow-y:auto;font-size:12px;line-height:1.4}
.log-entry{margin-bottom:5px;word-break:break-all}
.log-entry.info{color:#4CAF50}
.log-entry.warn{color:#FFA726}
.log-entry.error{color:#EF5350}
.status{padding:10px;border-radius:5px;margin-bottom:10px;text-align:center;font-weight:bold}
.status.connected{background:#1B5E20;border:2px solid #4CAF50}
.status.connecting{background:#E65100;border:2px solid #FF9800}
.status.disconnected{background:#B71C1C;border:2px solid #F44336}
button{background:#500078;color:#fff;border:2px solid #c900cc;padding:10px 20px;border-radius:5px;cursor:pointer;margin:5px;font-size:14px}
button:active{background:#c900cc}
input{background:#1a001a;color:#fff;border:2px solid var(--clr-neon);padding:8px;border-radius:5px;width:100%;margin-bottom:10px;font-family:'Courier New',monospace}
.info-grid{display:grid;grid-template-columns:auto 1fr;gap:5px 10px;font-size:14px}
.info-grid dt{color:#c4a1c7}
.info-grid dd{color:#fff;font-weight:bold}
</style>
</head>
<body>
<h1>üî¨ MQTT –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</h1>

<div class="section">
  <h2>–°—Ç–∞—Ç—É—Å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</h2>
  <div id="status" class="status disconnected">–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ</div>
  <div class="info-grid">
    <dt>–ë—Ä–∞—É–∑–µ—Ä:</dt><dd id="browser">‚Äî</dd>
    <dt>SharedWorker:</dt><dd id="sw-support">‚Äî</dd>
    <dt>WebSocket:</dt><dd id="ws-support">‚Äî</dd>
    <dt>–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:</dt><dd id="config-status">‚Äî</dd>
    <dt>–ü–æ—Å–ª–µ–¥–Ω–∏–π publish:</dt><dd id="last-publish">‚Äî</dd>
    <dt>–û—á–µ—Ä–µ–¥—å:</dt><dd id="queue-size">‚Äî</dd>
  </div>
</div>

<div class="section">
  <h2>–î–µ–π—Å—Ç–≤–∏—è</h2>
  <button onclick="testPublish()">üì§ –¢–µ—Å—Ç–æ–≤–∞—è –ø—É–±–ª–∏–∫–∞—Ü–∏—è</button>
  <button onclick="reconnect()">üîÑ –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</button>
  <button onclick="clearLogs()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏</button>
  <button onclick="clearConfig()">‚öôÔ∏è –°–±—Ä–æ—Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏</button>
</div>

<div class="section">
  <h2>–¢–µ—Å—Ç publish</h2>
  <input id="test-key" placeholder="–ö–ª—é—á (–Ω–∞–ø—Ä–∏–º–µ—Ä: lig_pwm)" value="lig_pwm">
  <input id="test-value" placeholder="–ó–Ω–∞—á–µ–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 75)" value="75">
  <button onclick="customPublish()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
</div>

<div class="section">
  <h2>–ñ—É—Ä–Ω–∞–ª —Å–æ–±—ã—Ç–∏–π</h2>
  <div id="log" class="log"></div>
</div>

<script type="module">
import MQTTManager from './mqtt-manager.js';

const statusEl = document.getElementById('status');
const logEl = document.getElementById('log');
const browserEl = document.getElementById('browser');
const swSupportEl = document.getElementById('sw-support');
const wsSupportEl = document.getElementById('ws-support');
const configStatusEl = document.getElementById('config-status');
const lastPublishEl = document.getElementById('last-publish');
const queueSizeEl = document.getElementById('queue-size');

let mqttManager = null;
let publishCount = 0;

// –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –±—Ä–∞—É–∑–µ—Ä–∞
function detectBrowser() {
  const ua = navigator.userAgent;
  if (/Chrome/.test(ua) && /Google Inc/.test(navigator.vendor)) return 'Chrome';
  if (/Safari/.test(ua) && /Apple/.test(navigator.vendor)) return 'Safari';
  if (/Firefox/.test(ua)) return 'Firefox';
  if (/Edg/.test(ua)) return 'Edge';
  return 'Unknown';
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π
function checkSupport() {
  browserEl.textContent = detectBrowser() + ' ' + (navigator.userAgent.match(/Version\/(\d+)/) || [])[1] || '';
  swSupportEl.textContent = typeof SharedWorker !== 'undefined' ? '‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è' : '‚ùå –ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è';
  wsSupportEl.textContent = typeof WebSocket !== 'undefined' ? '‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è' : '‚ùå –ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è';
}

// –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
function log(message, type = 'info') {
  const time = new Date().toLocaleTimeString('ru-RU');
  const entry = document.createElement('div');
  entry.className = `log-entry ${type}`;
  entry.textContent = `[${time}] ${message}`;
  logEl.insertBefore(entry, logEl.firstChild);
  
  // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π
  while (logEl.children.length > 100) {
    logEl.removeChild(logEl.lastChild);
  }
  
  console.log(`[MQTT Debug] ${message}`);
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
function updateStatus(status, message) {
  statusEl.className = `status ${status}`;
  statusEl.textContent = message || status;
  
  if (status === 'connected') {
    log('‚úÖ MQTT –ø–æ–¥–∫–ª—é—á–µ–Ω', 'info');
  } else if (status === 'connecting') {
    log('üîÑ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ MQTT...', 'info');
  } else if (status === 'disconnected') {
    log('‚ùå MQTT –æ—Ç–∫–ª—é—á–µ–Ω', 'error');
  }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
function loadConfig() {
  try {
    const stored = localStorage.getItem('gh_remote_cfg_v1');
    if (stored) {
      const cfg = JSON.parse(stored);
      configStatusEl.textContent = `‚úÖ ${cfg.host}:${cfg.port}/${cfg.base}`;
      return cfg;
    } else {
      configStatusEl.textContent = '‚ùå –ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ';
      return null;
    }
  } catch (e) {
    log('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: ' + e.message, 'error');
    configStatusEl.textContent = '‚ùå –û—à–∏–±–∫–∞';
    return null;
  }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è MQTT
function initMQTT() {
  const cfg = loadConfig();
  if (!cfg || !cfg.host || !cfg.port || !cfg.base) {
    log('‚ùå –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ.', 'error');
    return;
  }
  
  log('üì° –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è MQTT Manager...', 'info');
  
  try {
    mqttManager = new MQTTManager();
    
    mqttManager.on('status', (status) => {
      updateStatus(status, status === 'connected' ? '‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ' : 
                            status === 'connecting' ? 'üîÑ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...' : 
                            '‚ùå –û—Ç–∫–ª—é—á–µ–Ω–æ');
    });
    
    mqttManager.on('state', (state) => {
      log(`üì• –ü–æ–ª—É—á–µ–Ω–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${Object.keys(state).length} –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤`, 'info');
    });
    
    mqttManager.on('published', ({ key, value }) => {
      publishCount++;
      lastPublishEl.textContent = `${key}=${value} (#${publishCount})`;
      log(`üì§ –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ: ${key}=${value}`, 'info');
    });
    
    mqttManager.on('error', (error) => {
      log('‚ùå –û—à–∏–±–∫–∞ MQTT: ' + (error.message || error), 'error');
    });
    
    log('üîó –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±—Ä–æ–∫–µ—Ä—É...', 'info');
    mqttManager.connect(cfg);
    
  } catch (error) {
    log('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ' + error.message, 'error');
  }
}

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫
window.testPublish = function() {
  if (!mqttManager) {
    log('‚ùå MQTT Manager –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω', 'error');
    return;
  }
  
  const testKey = 'lig_pwm';
  const testValue = Math.floor(Math.random() * 100);
  
  log(`üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ publish: ${testKey}=${testValue}`, 'info');
  const success = mqttManager.publish(testKey, testValue);
  
  if (!success) {
    log('‚ö†Ô∏è Publish –≤–µ—Ä–Ω—É–ª false (–≤–æ–∑–º–æ–∂–Ω–æ, –≤ –æ—á–µ—Ä–µ–¥–∏)', 'warn');
  }
};

window.customPublish = function() {
  if (!mqttManager) {
    log('‚ùå MQTT Manager –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω', 'error');
    return;
  }
  
  const key = document.getElementById('test-key').value.trim();
  const value = document.getElementById('test-value').value.trim();
  
  if (!key || !value) {
    log('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∫–ª—é—á –∏ –∑–Ω–∞—á–µ–Ω–∏–µ', 'error');
    return;
  }
  
  log(`üì§ –û—Ç–ø—Ä–∞–≤–∫–∞: ${key}=${value}`, 'info');
  const success = mqttManager.publish(key, value);
  
  if (!success) {
    log('‚ö†Ô∏è Publish –≤–µ—Ä–Ω—É–ª false (–≤–æ–∑–º–æ–∂–Ω–æ, –≤ –æ—á–µ—Ä–µ–¥–∏)', 'warn');
  }
};

window.reconnect = function() {
  log('üîÑ –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...', 'info');
  if (mqttManager) {
    mqttManager.disconnect();
  }
  setTimeout(() => {
    initMQTT();
  }, 1000);
};

window.clearLogs = function() {
  logEl.innerHTML = '';
  log('üóëÔ∏è –õ–æ–≥–∏ –æ—á–∏—â–µ–Ω—ã', 'info');
};

window.clearConfig = function() {
  if (confirm('–£–¥–∞–ª–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é MQTT?')) {
    localStorage.removeItem('gh_remote_cfg_v1');
    log('‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —É–¥–∞–ª–µ–Ω–∞', 'info');
    configStatusEl.textContent = '‚ùå –ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ';
    location.reload();
  }
};

// –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ—á–µ—Ä–µ–¥–∏
setInterval(() => {
  // –≠—Ç–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –Ω–∞–ø—Ä—è–º—É—é, –Ω–æ –º–æ–∂–µ–º –æ—Ç—Å–ª–µ–¥–∏—Ç—å —á–µ—Ä–µ–∑ –ª–æ–≥–∏
  queueSizeEl.textContent = mqttManager && mqttManager.isConnected() ? '0 (–ø–æ–¥–∫–ª—é—á–µ–Ω–æ)' : '? (–æ—Ç–∫–ª—é—á–µ–Ω–æ)';
}, 1000);

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
checkSupport();
log('üöÄ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–∞', 'info');
log('üì± User Agent: ' + navigator.userAgent, 'info');

// –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
const cfg = loadConfig();
if (cfg) {
  initMQTT();
} else {
  log('‚ö†Ô∏è MQTT –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.', 'warn');
  statusEl.innerHTML = '‚ö†Ô∏è –ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ<br><a href="index.html" style="color:#fff;text-decoration:underline">–ù–∞—Å—Ç—Ä–æ–∏—Ç—å</a>';
}
</script>
</body>
</html>
