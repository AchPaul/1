<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GrowHub - –¢–µ—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #1a1a2e; color: #eee; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; }
        h1 { margin-bottom: 20px; color: #0f3; }
        .status { padding: 15px; background: #2a2a3e; border-radius: 8px; margin-bottom: 20px; }
        .connected { color: #0f3; }
        .disconnected { color: #f33; }
        .alert { padding: 15px; margin: 10px 0; border-radius: 8px; border-left: 4px solid; animation: slideIn 0.3s; }
        .alert.water { background: #1e3a5f; border-color: #4a90e2; }
        .alert.humid { background: #1e5f3a; border-color: #4ae290; }
        .alert.temp_high { background: #5f1e1e; border-color: #e24a4a; }
        .alert.temp_low { background: #1e1e5f; border-color: #4a4ae2; }
        .alert.sensor { background: #5f5f1e; border-color: #e2e24a; }
        .alert-time { font-size: 0.8em; color: #999; margin-top: 5px; }
        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        button { 
            padding: 12px 24px; 
            background: #0f3; 
            border: none; 
            border-radius: 8px; 
            color: #000; 
            font-weight: bold; 
            cursor: pointer; 
            margin: 5px;
        }
        button:hover { background: #0c2; }
        .log { 
            max-height: 400px; 
            overflow-y: auto; 
            background: #0a0a1a; 
            padding: 15px; 
            border-radius: 8px; 
            margin-top: 20px;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üö® GrowHub Alerts</h1>
        
        <div class="status">
            <div>–°—Ç–∞—Ç—É—Å SSE: <span id="status" class="disconnected">–û—Ç–∫–ª—é—á–µ–Ω–æ</span></div>
            <div>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –±—Ä–∞—É–∑–µ—Ä–∞: <span id="notif-status">–ù–µ –∑–∞–ø—Ä–æ—à–µ–Ω—ã</span></div>
        </div>

        <div>
            <button onclick="requestNotifications()">üîî –ó–∞–ø—Ä–æ—Å–∏—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</button>
            <button onclick="testNotification()">üß™ –¢–µ—Å—Ç –Ω–∞—Ç–∏–≤–Ω–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</button>
            <button onclick="clearLog()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
        </div>

        <div id="alerts"></div>
        
        <h3 style="margin-top: 30px;">–õ–æ–≥ —Å–æ–±—ã—Ç–∏–π:</h3>
        <div id="log" class="log"></div>
    </div>

    <script>
        let eventSource = null;
        const alertsDiv = document.getElementById('alerts');
        const logDiv = document.getElementById('log');
        const statusSpan = document.getElementById('status');
        const notifStatusSpan = document.getElementById('notif-status');

        // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ SSE
        function connectSSE() {
            // –ß–∏—Ç–∞–µ–º IP –∏–∑ URL params –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–∏–π —Ö–æ—Å—Ç
            const urlParams = new URLSearchParams(window.location.search);
            const deviceIP = urlParams.get('ip') || window.location.hostname;
            
            const sseURL = `http://${deviceIP}/events`;
            log(`–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ ${sseURL}...`);

            eventSource = new EventSource(sseURL);

            eventSource.onopen = () => {
                statusSpan.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
                statusSpan.className = 'connected';
                log('‚úÖ SSE –ø–æ–¥–∫–ª—é—á–µ–Ω');
            };

            eventSource.onerror = (error) => {
                statusSpan.textContent = '–û—à–∏–±–∫–∞';
                statusSpan.className = 'disconnected';
                log('‚ùå –û—à–∏–±–∫–∞ SSE, –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...');
                eventSource.close();
                setTimeout(connectSSE, 5000); // –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫
            };

            // –°–ª—É—à–∞–µ–º —Å–æ–±—ã—Ç–∏—è —Ç–∏–ø–∞ "alert"
            eventSource.addEventListener('alert', (event) => {
                try {
                    const data = JSON.parse(event.data);
                    log(`üì® –ü–æ–ª—É—á–µ–Ω–æ: ${data.type} - ${data.message}`);
                    showAlert(data);
                    showNativeNotification(data);
                } catch (e) {
                    log(`‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞: ${e.message}`);
                }
            });
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å alert –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
        function showAlert(data) {
            const alert = document.createElement('div');
            alert.className = `alert ${data.type}`;
            alert.innerHTML = `
                <div>${data.message}</div>
                <div class="alert-time">${new Date(data.timestamp).toLocaleTimeString('ru-RU')}</div>
            `;
            alertsDiv.insertBefore(alert, alertsDiv.firstChild);

            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –∞–ª–µ—Ä—Ç—ã (–æ—Å—Ç–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5)
            while (alertsDiv.children.length > 5) {
                alertsDiv.removeChild(alertsDiv.lastChild);
            }
        }

        // –ù–∞—Ç–∏–≤–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –±—Ä–∞—É–∑–µ—Ä–∞
        function showNativeNotification(data) {
            if (Notification.permission === 'granted') {
                const options = {
                    body: data.message,
                    icon: '/favicon.ico',
                    badge: '/favicon.ico',
                    requireInteraction: true, // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–µ –∏—Å—á–µ–∑–Ω–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
                    tag: data.type // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ —Ç–∏–ø—É
                };

                const notification = new Notification('GrowHub Alert', options);
                
                notification.onclick = () => {
                    window.focus();
                    notification.close();
                };
            }
        }

        // –ó–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        async function requestNotifications() {
            if (!('Notification' in window)) {
                alert('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è');
                return;
            }

            const permission = await Notification.requestPermission();
            updateNotificationStatus(permission);
            
            if (permission === 'granted') {
                log('‚úÖ –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—É—á–µ–Ω–æ');
            } else {
                log('‚ùå –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ');
            }
        }

        // –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        function updateNotificationStatus(permission) {
            switch(permission) {
                case 'granted':
                    notifStatusSpan.textContent = '‚úÖ –†–∞–∑—Ä–µ—à–µ–Ω—ã';
                    notifStatusSpan.style.color = '#0f3';
                    break;
                case 'denied':
                    notifStatusSpan.textContent = '‚ùå –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã';
                    notifStatusSpan.style.color = '#f33';
                    break;
                default:
                    notifStatusSpan.textContent = '‚è≥ –ù–µ –∑–∞–ø—Ä–æ—à–µ–Ω—ã';
                    notifStatusSpan.style.color = '#fa3';
            }
        }

        // –¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        function testNotification() {
            const testData = {
                type: 'water',
                message: 'üß™ –¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ GrowHub',
                timestamp: Date.now()
            };
            showAlert(testData);
            showNativeNotification(testData);
            log('üß™ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Ç–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ');
        }

        // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
        function log(message) {
            const entry = document.createElement('div');
            entry.textContent = `[${new Date().toLocaleTimeString('ru-RU')}] ${message}`;
            logDiv.insertBefore(entry, logDiv.firstChild);
        }

        // –û—á–∏—Å—Ç–∫–∞ –ª–æ–≥–∞
        function clearLog() {
            logDiv.innerHTML = '';
            alertsDiv.innerHTML = '';
            log('üóëÔ∏è –õ–æ–≥ –æ—á–∏—â–µ–Ω');
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        window.onload = () => {
            updateNotificationStatus(Notification.permission);
            connectSSE();
            log('üöÄ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
        };

        // –ó–∞–∫—Ä—ã—Ç–∏–µ SSE –ø—Ä–∏ —É—Ö–æ–¥–µ
        window.onbeforeunload = () => {
            if (eventSource) eventSource.close();
        };
    </script>
</body>
</html>
