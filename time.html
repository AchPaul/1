<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>GrowHub - Настройка времени</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#28003c">
<style>
:root{--clr-neon:hsl(288,52%,35%);--clr-bg:hsl(295,14%,67%)}
*{margin:0;padding:0;box-sizing:border-box}
body{background:#000;color:#fff;font-family:'Courier New',monospace}
h2{text-align:center;padding:0 5px}
.neon-buttom{background:#000;font-size:16px;text-decoration:none;color:#ebebeb;cursor:pointer;border:var(--clr-neon) .125em solid;padding:.35em 2em;border-radius:.25em;width:260px;text-align:center;box-shadow:inset 0 0 .5em 0 var(--clr-neon),0 0 .5em 0 var(--clr-neon);position:relative}
.neon-buttom:disabled{background:#3d3b3d;color:#fff;cursor:wait}
.neon-buttom::before{content:"";position:absolute;background:var(--clr-neon);top:120%;left:0;width:100%;height:100%;transform:perspective(3em)rotateX(40deg)scale(1,.35);filter:blur(1em);opacity:.7}
.neon-buttom::after{content:"";position:absolute;background:var(--clr-neon);top:0;left:0;bottom:0;right:0;box-shadow:0 0 2em .5em var(--clr-neon);opacity:0;z-index:-1;transition:opacity 100ms}
.neon-buttom:hover,.neon-buttom:focus{color:var(--clr-bg);text-shadow:none}
.neon-buttom:hover::before,.neon-buttom:focus::before,.neon-buttom:hover::after,.neon-buttom:focus::after{opacity:1}
.icon{position:relative}
.icon_btn{position:absolute;top:3px;left:10px}
.main{display:flex;margin:20px 0;justify-content:center;align-items:center;flex-direction:column;gap:25px}
.group_input{color:#fff;width:300px;padding:10px;border:2px solid var(--clr-neon);border-radius:8px;background:transparent;font-size:16px;transition:box-shadow .3s}
input[type=range]{-webkit-appearance:none;appearance:none;width:100%;height:15px;border-radius:5px;background:#d3d3d3;outline:0;opacity:.7;transition:opacity .15s;margin-top:10px}
input[type=range]:hover{opacity:1}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:30px;height:30px;border-radius:50%;background:#bd65e5;cursor:pointer}
input[type=range]::-moz-range-thumb{width:30px;height:30px;border-radius:50%;background:#bd65e5;cursor:pointer}
.slider-container{margin-top:0;font-size:18px;color:#fff;margin-bottom:20px}
.slider-title{display:flex;flex-direction:column}
.slider-title div{display:flex;justify-content:space-evenly;margin-bottom:10px}
.slider-value{font-weight:700;transition:all .3s}
.slider{transition:all .3s}
header{height:75px;background:linear-gradient(135deg,#500078 0%,#28003c 100%);display:flex;align-items:center;justify-content:center;box-shadow:0 4px 15px rgba(0,0,0,.5);position:relative;z-index:100}
.header-transition{height:40px;background:linear-gradient(#370053,#000);margin-top:-10px;margin-bottom:15px}
.logo{margin-top:2px;display:inline-block}
.grow{font-size:35px;color:#fff;font-weight:700;letter-spacing:5px}
.hub{font-size:35px;color:#c900cc;font-weight:700;letter-spacing:5px;border:7px solid #c900cc;border-radius:13px;padding:2px 2px 2px 8px}
.container_clue{width:300px;padding:10px;font-size:16px;margin-left:20px}
.trigger_clue{cursor:pointer;display:block;background:#000;font-size:16px;text-decoration:none;color:#ebebeb;border:var(--clr-neon) .125em solid;padding:.35em 2em;border-radius:.25em;width:260px;text-align:center;box-shadow:inset 0 0 .5em 0 var(--clr-neon),0 0 .5em 0 var(--clr-neon);position:relative}
.content_clue{margin-top:10px;margin-left:-20px;width:300px;padding:10px;border:2px solid var(--clr-neon);border-radius:8px;background:transparent;color:#fedbff;font-size:16px;display:none}
#status-box{padding:10px;margin-bottom:10px;text-align:center;font-size:14px}
</style>
</head>
<body>
<header>
<div class="logo"><span class="grow">Grow</span><span class="hub">Hub</span></div>
</header>
<div class="header-transition"></div>
<main class="main">
<div id="status-box"></div>
<h2 style="margin-bottom:10px">Настройка времени включения освещения</h2>
<div class="container_clue">
<p class="trigger_clue">Как настроить?</p>
<div class="content_clue">
<p>1) Выставьте время включения освещения (в какой час включается свет).</p>
<br>
<p>2) Выставьте текущее время (сколько сейчас часов).</p>
<br>
<p>Пример:</p>
<p>Лампа должна включаться в 9:00 утра.</p>
<p>Сейчас 13:00.</p>
<p>Установите: "Включение освещения: 9" и "Текущее время: 13".</p>
</div>
</div>
<section class="group_input">
<form id="time-form">
<div class="slider-container">
<div class="slider-title"><div><span>Включение освещения:</span></div></div>
<span class="slider-value" id="light-on-val">0</span>:00
<input type="range" class="slider" id="light-on" min="0" max="23" value="0">
</div>
<div class="slider-container">
<div class="slider-title"><div><span>Текущее время:</span></div></div>
<span class="slider-value" id="current-time-val">0</span>:00
<input type="range" class="slider" id="current-time" min="0" max="23" value="0">
</div>
<div style="text-align:center;margin-top:10px">
<input class="neon-buttom icon" type="submit" value="Сохранить" id="btn-save">
</div>
</form>
</section>
<a class="neon-buttom icon" href="service.html">Выйти<div class="icon_btn"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="#fff"><path d="M21 11H6.414l5.293-5.293-1.414-1.414L2.586 12l7.707 7.707 1.414-1.414L6.414 13H21z"/></svg></div></a>
</main>
<script src="mqtt-manager.js"></script>
<script src="app_optimized.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  const statusBox = document.getElementById('status-box');
  const lightOnSlider = document.getElementById('light-on');
  const currentTimeSlider = document.getElementById('current-time');
  const lightOnVal = document.getElementById('light-on-val');
  const currentTimeVal = document.getElementById('current-time-val');
  const form = document.getElementById('time-form');
  const btnSave = document.getElementById('btn-save');
  
  // MQTT клиент для этой страницы
  let mqttManager = null;
  let connected = false;
  
  // Загрузка конфигурации из localStorage
  function loadConfig(){
    const stored = localStorage.getItem('gh_remote_cfg_v1');
    if(stored){ try { return JSON.parse(stored); } catch(_){} }
    return null;
  }
  
  function connectMqtt(){
    const cfg = loadConfig();
    if(!cfg || !cfg.host || !cfg.port || !cfg.base){
      statusBox.textContent = '❌ Нет сохранённых настроек MQTT. Сначала откройте главную страницу.';
      statusBox.style.color = '#ef9aa0';
      return;
    }
    
    try {
      console.log('[Time] Initializing MQTTManager');
      mqttManager = new MQTTManager();
      
      mqttManager.on('status', (status) => {
        connected = (status === 'connected');
        console.log('[Time] MQTT status:', status);
      });
      
      mqttManager.on('state', (state) => {
        console.log('[Time] State received:', state);
        // Устанавливаем сохранённое значение включения света
        if(state.light_on_hour !== undefined){
          lightOnSlider.value = state.light_on_hour;
          lightOnVal.textContent = state.light_on_hour;
        }
      });
      
      mqttManager.on('error', (error) => {
        console.error('[Time] MQTT error:', error);
        statusBox.textContent = '❌ Ошибка MQTT: ' + error;
        statusBox.style.color = '#ef9aa0';
      });
      
      console.log('[Time] Connecting to MQTT...');
      mqttManager.connect(cfg);
      
    } catch(e) {
      console.error('[Time] Init error:', e);
      statusBox.textContent = '❌ Ошибка инициализации: ' + e.message;
      statusBox.style.color = '#ef9aa0';
    }
  }
  
  function publish(key, val){
    if(!connected || !mqttManager){
      statusBox.textContent = '❌ MQTT не подключен';
      statusBox.style.color = '#ef9aa0';
      return false;
    }
    console.log('[Time] Publishing:', key, '=', val);
    mqttManager.publish(key, String(val));
    return true;
  }
  
  // Инициализация текущего времени
  const now = new Date();
  currentTimeSlider.value = now.getHours();
  currentTimeVal.textContent = now.getHours();
  
  // Обновление значений слайдеров
  function updateSlider(slider, label){
    label.textContent = slider.value;
  }
  
  lightOnSlider.addEventListener('input', ()=> updateSlider(lightOnSlider, lightOnVal));
  currentTimeSlider.addEventListener('input', ()=> updateSlider(currentTimeSlider, currentTimeVal));
  
  // Обработка формы
  form.addEventListener('submit', function(e){
    e.preventDefault();
    
    const lightOn = parseInt(lightOnSlider.value);
    const currentHour = parseInt(currentTimeSlider.value);
    
    // Публикация через MQTT: формат "light_on:current_hour"
    const payload = lightOn + ':' + currentHour;
    
    if(publish('set_time', payload)){
      btnSave.value = 'Сохранено ✓';
      btnSave.disabled = true;
      setTimeout(()=>{ btnSave.value = 'Сохранить'; btnSave.disabled = false; }, 2000);
    }
  });
  
  // Обработка "Как настроить?"
  const trigger = document.querySelector('.trigger_clue');
  const content = document.querySelector('.content_clue');
  let isShown = false;
  
  trigger.addEventListener('click', ()=>{
    if(!isShown){
      content.style.display = 'block';
      isShown = true;
    } else {
      content.style.display = 'none';
      isShown = false;
    }
  });
  
  // Подключение к MQTT при загрузке страницы
  connectMqtt();
});
</script>
</body>
</html>
