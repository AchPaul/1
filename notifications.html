<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>GrowHub - –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</title>
<link rel="icon" type="image/svg+xml" href="favicon-plant.svg">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#28003c">
<style>
:root{--clr-neon:hsl(288,52%,35%);--clr-bg:hsl(295,14%,67%);--clr-success:#22c55e;--clr-error:#ef4444;--clr-warning:#f59e0b}
*{margin:0;padding:0;box-sizing:border-box}
body{background:#000;color:#fff;font-family:'Courier New',monospace;min-height:100vh}
h2,h3{text-align:center;padding:0 5px}
.neon-buttom{background:#000;font-size:16px;text-decoration:none;color:#ebebeb;cursor:pointer;border:var(--clr-neon) .125em solid;padding:.35em 2em;border-radius:.25em;width:260px;text-align:center;box-shadow:inset 0 0 .5em 0 var(--clr-neon),0 0 .5em 0 var(--clr-neon);position:relative}
.neon-buttom:disabled{background:#3d3b3d;color:#888;cursor:not-allowed}
.neon-buttom::before{content:"";position:absolute;background:var(--clr-neon);top:120%;left:0;width:100%;height:100%;transform:perspective(3em)rotateX(40deg)scale(1,.35);filter:blur(1em);opacity:.7}
.neon-buttom::after{content:"";position:absolute;background:var(--clr-neon);top:0;left:0;bottom:0;right:0;box-shadow:0 0 2em .5em var(--clr-neon);opacity:0;z-index:-1;transition:opacity 100ms}
.neon-buttom:hover:not(:disabled),.neon-buttom:focus:not(:disabled){color:var(--clr-bg);text-shadow:none}
.neon-buttom:hover:not(:disabled)::before,.neon-buttom:focus:not(:disabled)::before,.neon-buttom:hover:not(:disabled)::after,.neon-buttom:focus:not(:disabled)::after{opacity:1}
.btn-success{border-color:var(--clr-success);box-shadow:inset 0 0 .5em 0 var(--clr-success),0 0 .5em 0 var(--clr-success)}
.btn-success::before,.btn-success::after{background:var(--clr-success)}
.btn-danger{border-color:var(--clr-error);box-shadow:inset 0 0 .5em 0 var(--clr-error),0 0 .5em 0 var(--clr-error)}
.btn-danger::before,.btn-danger::after{background:var(--clr-error)}
.main{display:flex;margin:20px 0;justify-content:center;align-items:center;flex-direction:column;gap:20px;padding:0 15px}
header{height:75px;background:linear-gradient(135deg,#500078 0%,#28003c 100%);display:flex;align-items:center;justify-content:center;box-shadow:0 4px 15px rgba(0,0,0,.5);position:relative;z-index:100}
.header-transition{height:40px;background:linear-gradient(#370053,#000);margin-top:-10px;margin-bottom:15px}
.logo{margin-top:2px;display:inline-block}
.grow{font-size:35px;color:#fff;font-weight:700;letter-spacing:5px}
.hub{font-size:35px;color:#c900cc;font-weight:700;letter-spacing:5px;border:7px solid #c900cc;border-radius:13px;padding:2px 2px 2px 8px}
.status-line{font-size:12px;text-align:center;opacity:.85;margin:0 0 10px;color:#e6d8f5}
.status-line.warn{color:#ff9aa0}
.status-line.success{color:#86efac}

/* Card styles */
.card{background:linear-gradient(135deg,rgba(138,43,226,.1) 0%,rgba(75,0,130,.1) 100%);border:2px solid rgba(138,43,226,.3);border-radius:15px;padding:20px;box-shadow:0 0 20px rgba(138,43,226,.2);width:100%;max-width:340px}
.card-title{font-size:18px;margin-bottom:15px;text-align:center;color:#e6d8f5}
.card-description{font-size:13px;color:#a78bba;text-align:center;margin-bottom:15px;line-height:1.5}

/* Status badge */
.status-badge{display:inline-flex;align-items:center;gap:8px;padding:8px 16px;border-radius:20px;font-size:14px;margin-bottom:15px}
.status-badge.enabled{background:rgba(34,197,94,.2);border:1px solid var(--clr-success);color:#86efac}
.status-badge.disabled{background:rgba(239,68,68,.2);border:1px solid var(--clr-error);color:#fca5a5}
.status-badge.pending{background:rgba(245,158,11,.2);border:1px solid var(--clr-warning);color:#fcd34d}
.status-badge .dot{width:8px;height:8px;border-radius:50%;background:currentColor;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}

/* Toggle styles */
.toggle-group{display:flex;flex-direction:column;gap:12px;margin-top:15px}
.toggle-item{display:flex;align-items:center;justify-content:space-between;padding:12px;background:rgba(0,0,0,.3);border-radius:10px;border:1px solid rgba(138,43,226,.2)}
.toggle-item label{font-size:14px;color:#e6d8f5;cursor:pointer;flex:1}
.toggle-item .toggle-switch{position:relative;width:50px;height:26px;cursor:pointer}
.toggle-item input{opacity:0;width:0;height:0}
.toggle-switch .slider{position:absolute;top:0;left:0;right:0;bottom:0;background:#333;border-radius:26px;transition:.3s}
.toggle-switch .slider::before{content:"";position:absolute;width:20px;height:20px;left:3px;bottom:3px;background:#666;border-radius:50%;transition:.3s}
.toggle-switch input:checked + .slider{background:var(--clr-success)}
.toggle-switch input:checked + .slider::before{transform:translateX(24px);background:#fff}
.toggle-switch input:disabled + .slider{opacity:.5;cursor:not-allowed}

/* iOS notice */
.ios-notice{background:rgba(245,158,11,.15);border:1px solid var(--clr-warning);border-radius:10px;padding:15px;margin-bottom:15px;font-size:13px;line-height:1.5}
.ios-notice strong{color:var(--clr-warning)}
.ios-notice ol{margin:10px 0 0 20px}
.ios-notice li{margin:5px 0}

/* Test button */
.test-section{margin-top:20px;padding-top:20px;border-top:1px solid rgba(138,43,226,.2)}
.test-btn{width:100%;padding:12px;background:rgba(138,43,226,.2);border:1px solid var(--clr-neon);border-radius:8px;color:#fff;font-family:inherit;font-size:14px;cursor:pointer;transition:all .2s}
.test-btn:hover{background:rgba(138,43,226,.4)}
.test-btn:disabled{opacity:.5;cursor:not-allowed}

/* Permission denied notice */
.blocked-notice{background:rgba(239,68,68,.15);border:1px solid var(--clr-error);border-radius:10px;padding:15px;font-size:13px;line-height:1.5}
.blocked-notice a{color:#fca5a5}

/* Browser support info */
.browser-info{font-size:12px;color:#888;text-align:center;margin-top:10px}
</style>
</head>
<body>
<header>
<div class="logo"><span class="grow">Grow</span><span class="hub">Hub</span></div>
</header>
<div class="header-transition"></div>
<div class="status-line" id="status-line">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

<main class="main">
<h2>üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h2>

<!-- –°—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏ -->
<div class="card" id="status-card">
<div style="text-align:center">
<div class="status-badge disabled" id="push-status">
<span class="dot"></span>
<span id="status-text">–ü—Ä–æ–≤–µ—Ä–∫–∞...</span>
</div>
</div>
<p class="card-description" id="status-description">
–ü–æ–ª—É—á–∞–π—Ç–µ –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ —Ç–µ–ø–ª–∏—Ü—ã –ø—Ä—è–º–æ –Ω–∞ –≤–∞—à–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ.
</p>

<!-- iOS Notice (hidden by default) -->
<div class="ios-notice hidden" id="ios-notice">
<strong>üì± –î–ª—è iOS —É—Å—Ç—Ä–æ–π—Å—Ç–≤:</strong>
<ol>
<li>–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–ü–æ–¥–µ–ª–∏—Ç—å—Å—è" (üì§)</li>
<li>–í—ã–±–µ—Ä–∏—Ç–µ "–ù–∞ —ç–∫—Ä–∞–Ω –î–æ–º–æ–π"</li>
<li>–û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å –≥–ª–∞–≤–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∞</li>
<li>–í–µ—Ä–Ω–∏—Ç–µ—Å—å –Ω–∞ —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</li>
</ol>
</div>

<!-- Permission blocked notice (hidden by default) -->
<div class="blocked-notice hidden" id="blocked-notice">
<strong>üö´ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã</strong>
<p style="margin-top:8px">
–í—ã —Ä–∞–Ω–µ–µ –∑–∞–ø—Ä–µ—Ç–∏–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è —ç—Ç–æ–≥–æ —Å–∞–π—Ç–∞. –ß—Ç–æ–±—ã –≤–∫–ª—é—á–∏—Ç—å –∏—Ö:
</p>
<ol style="margin:10px 0 0 20px">
<li>–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∑–Ω–∞—á–æ–∫ üîí –≤ –∞–¥—Ä–µ—Å–Ω–æ–π —Å—Ç—Ä–æ–∫–µ</li>
<li>–ù–∞–π–¥–∏—Ç–µ "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è" –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö</li>
<li>–ò–∑–º–µ–Ω–∏—Ç–µ –Ω–∞ "–†–∞–∑—Ä–µ—à–∏—Ç—å"</li>
<li>–û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É</li>
</ol>
</div>

<!-- Main action button -->
<div style="text-align:center;margin-top:15px">
<button class="neon-buttom btn-success" id="btn-enable" style="width:100%">üîî –í–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</button>
<button class="neon-buttom btn-danger hidden" id="btn-disable" style="width:100%">üîï –û—Ç–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</button>
</div>

<!-- Test notification -->
<div class="test-section" id="test-section" style="display:none">
<button class="test-btn" id="btn-test">üì¨ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</button>
<button class="test-btn" id="btn-test-all" style="margin-top:10px">üîî –¢–µ—Å—Ç –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (5 —à—Ç—É–∫)</button>
</div>

<div class="browser-info" id="browser-info"></div>
</div>

<!-- –¢–∏–ø—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
<div class="card hidden" id="alerts-card">
<h3 class="card-title">–¢–∏–ø—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</h3>
<p class="card-description">–í—ã–±–µ—Ä–∏—Ç–µ, –æ –∫–∞–∫–∏—Ö —Å–æ–±—ã—Ç–∏—è—Ö –≤—ã —Ö–æ—Ç–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:</p>

<div class="toggle-group" id="alert-toggles">
<div class="toggle-item">
<label for="alert_water">üíß –ë–∞–∫ –¥–ª—è –≤–æ–¥—ã –ø—É—Å—Ç</label>
<div class="toggle-switch">
<input type="checkbox" id="alert_water" checked>
<span class="slider"></span>
</div>
</div>

<div class="toggle-item">
<label for="alert_humid">üí® –£–≤–ª–∞–∂–Ω–∏—Ç–µ–ª—å –ø—É—Å—Ç</label>
<div class="toggle-switch">
<input type="checkbox" id="alert_humid" checked>
<span class="slider"></span>
</div>
</div>

<div class="toggle-item">
<label for="alert_high_temp">üå°Ô∏è –í—ã—Å–æ–∫–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞</label>
<div class="toggle-switch">
<input type="checkbox" id="alert_high_temp" checked>
<span class="slider"></span>
</div>
</div>

<div class="toggle-item">
<label for="alert_low_temp">‚ùÑÔ∏è –ù–∏–∑–∫–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞</label>
<div class="toggle-switch">
<input type="checkbox" id="alert_low_temp" checked>
<span class="slider"></span>
</div>
</div>

<div class="toggle-item">
<label for="err_sensor">‚ö†Ô∏è –û—à–∏–±–∫–∏ –¥–∞—Ç—á–∏–∫–æ–≤</label>
<div class="toggle-switch">
<input type="checkbox" id="err_sensor" checked>
<span class="slider"></span>
</div>
</div>

<div class="toggle-item">
<label for="rebooted">‚ö° –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</label>
<div class="toggle-switch">
<input type="checkbox" id="rebooted" checked>
<span class="slider"></span>
</div>
</div>
</div>
</div>

<a href="service.html" class="neon-buttom">‚Üê –ù–∞–∑–∞–¥</a>
</main>

<script src="push-notifications.js"></script>
<script>
(function(){
  const statusLine = document.getElementById('status-line');
  const pushStatus = document.getElementById('push-status');
  const statusText = document.getElementById('status-text');
  const statusDescription = document.getElementById('status-description');
  const iosNotice = document.getElementById('ios-notice');
  const blockedNotice = document.getElementById('blocked-notice');
  const btnEnable = document.getElementById('btn-enable');
  const btnDisable = document.getElementById('btn-disable');
  const btnTest = document.getElementById('btn-test');
  const testSection = document.getElementById('test-section');
  const alertsCard = document.getElementById('alerts-card');
  const browserInfo = document.getElementById('browser-info');
  const alertToggles = document.getElementById('alert-toggles');
  
  function logStatus(msg, type = 'info'){
    if(statusLine){
      statusLine.textContent = msg;
      statusLine.classList.toggle('warn', type === 'warn');
      statusLine.classList.toggle('success', type === 'success');
    }
  }
  
  function updateUI(){
    if(!window.pushManager) return;
    
    const caps = window.pushManager.getCapabilities();
    const config = window.pushManager.loadConfig();
    
    console.log('[Notifications] Capabilities:', caps);
    console.log('[Notifications] Config:', config);
    
    // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±—Ä–∞—É–∑–µ—Ä–µ
    if(browserInfo && caps.browserInfo){
      browserInfo.textContent = `${caps.browserInfo.name}${caps.browserInfo.version ? ' ' + caps.browserInfo.version : ''} ‚Ä¢ ${caps.browserInfo.supportsWebPush ? 'Web Push ‚úì' : '–õ–æ–∫–∞–ª—å–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è'}`;
    }
    
    // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    iosNotice.classList.add('hidden');
    blockedNotice.classList.add('hidden');
    
    // iOS —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞
    if(caps.isIOS && !caps.isIOSPWA && caps.supportLevel === 'ios-limited'){
      iosNotice.classList.remove('hidden');
      statusDescription.textContent = '–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –Ω–∞ iOS, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω.';
    }
    
    // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã
    if(caps.permission === 'denied'){
      blockedNotice.classList.remove('hidden');
      pushStatus.className = 'status-badge disabled';
      statusText.textContent = '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã';
      btnEnable.disabled = true;
      btnEnable.textContent = 'üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ';
      return;
    }
    
    // –ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è
    if(!caps.supported && caps.supportLevel === 'none'){
      pushStatus.className = 'status-badge disabled';
      statusText.textContent = '–ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è';
      statusDescription.textContent = '–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.';
      btnEnable.disabled = true;
      btnEnable.textContent = 'üö´ –ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è';
      return;
    }
    
    // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã
    if(config.enabled){
      pushStatus.className = 'status-badge enabled';
      statusText.textContent = '–í–∫–ª—é—á–µ–Ω—ã';
      statusDescription.textContent = caps.isSubscribed 
        ? '–í—ã –±—É–¥–µ—Ç–µ –ø–æ–ª—É—á–∞—Ç—å push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å–æ–±—ã—Ç–∏—è—Ö —Ç–µ–ø–ª–∏—Ü—ã.'
        : '–í—ã –±—É–¥–µ—Ç–µ –ø–æ–ª—É—á–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å–æ–±—ã—Ç–∏—è—Ö —Ç–µ–ø–ª–∏—Ü—ã.';
      
      btnEnable.classList.add('hidden');
      btnDisable.classList.remove('hidden');
      testSection.style.display = 'block';
      alertsCard.classList.remove('hidden');
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–∏–ø–æ–≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
      loadAlertPreferences();
      logStatus('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω—ã', 'success');
    } else {
      pushStatus.className = 'status-badge pending';
      statusText.textContent = '–û—Ç–∫–ª—é—á–µ–Ω—ã';
      statusDescription.textContent = '–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –≤–∞–∂–Ω—ã—Ö —Å–æ–±—ã—Ç–∏—è—Ö.';
      
      btnEnable.classList.remove('hidden');
      btnDisable.classList.add('hidden');
      testSection.style.display = 'none';
      alertsCard.classList.add('hidden');
      logStatus('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–∫–ª—é—á–µ–Ω—ã');
    }
  }
  
  function loadAlertPreferences(){
    if(!window.pushManager) return;
    const prefs = window.pushManager.getAlertPreferences();
    
    Object.keys(prefs).forEach(key => {
      // –û–±—ä–µ–¥–∏–Ω—è–µ–º –≤—Å–µ –æ—à–∏–±–∫–∏ –¥–∞—Ç—á–∏–∫–æ–≤ –≤ –æ–¥–∏–Ω –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å
      if(key.startsWith('err_sensor')){
        const toggle = document.getElementById('err_sensor');
        if(toggle) toggle.checked = prefs[key];
      } else {
        const toggle = document.getElementById(key);
        if(toggle) toggle.checked = prefs[key];
      }
    });
  }
  
  function saveAlertPreferences(){
    if(!window.pushManager) return;
    
    const prefs = {};
    const toggles = alertToggles.querySelectorAll('input[type="checkbox"]');
    
    toggles.forEach(toggle => {
      const key = toggle.id;
      if(key === 'err_sensor'){
        // –ü—Ä–∏–º–µ–Ω—è–µ–º –∫–æ –≤—Å–µ–º –æ—à–∏–±–∫–∞–º –¥–∞—Ç—á–∏–∫–æ–≤
        prefs.err_sensor_temp = toggle.checked;
        prefs.err_sensor_hg = toggle.checked;
        prefs.err_sensor_hg2 = toggle.checked;
        prefs.err_sensor_dht = toggle.checked;
      } else {
        prefs[key] = toggle.checked;
      }
    });
    
    window.pushManager.setAlertPreferences(prefs);
    logStatus('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
  }
  
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –≤–∫–ª—é—á–µ–Ω–∏—è
  btnEnable.addEventListener('click', async () => {
    if(!window.pushManager) return;
    
    btnEnable.disabled = true;
    btnEnable.textContent = '‚è≥ –ü–æ–¥–æ–∂–¥–∏—Ç–µ...';
    logStatus('–ó–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è...');
    
    try {
      await window.pushManager.subscribe();
      logStatus('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã!', 'success');
      updateUI();
    } catch(err) {
      console.error('[Notifications] Subscribe error:', err);
      logStatus(err.message || '–û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏', 'warn');
      btnEnable.disabled = false;
      btnEnable.textContent = 'üîî –í–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è';
      updateUI();
    }
  });
  
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è
  btnDisable.addEventListener('click', async () => {
    if(!window.pushManager) return;
    
    btnDisable.disabled = true;
    logStatus('–û—Ç–∫–ª—é—á–µ–Ω–∏–µ...');
    
    try {
      await window.pushManager.unsubscribe();
      logStatus('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–∫–ª—é—á–µ–Ω—ã');
      updateUI();
    } catch(err) {
      console.error('[Notifications] Unsubscribe error:', err);
      logStatus('–û—à–∏–±–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è', 'warn');
    }
    
    btnDisable.disabled = false;
  });
  
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
  btnTest.addEventListener('click', async () => {
    if(!window.pushManager) return;
    
    btnTest.disabled = true;
    btnTest.textContent = 'üì§ –û—Ç–ø—Ä–∞–≤–∫–∞...';
    
    try {
      const success = await window.pushManager.showLocalNotification(
        'üå± –¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ',
        {
          body: '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è GrowHub —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!',
          tag: 'growhub-test',
          data: { url: window.location.href, type: 'test' }
        }
      );
      
      if(success){
        logStatus('–¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!', 'success');
      } else {
        logStatus('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ', 'warn');
      }
    } catch(err) {
      console.error('[Notifications] Test error:', err);
      logStatus('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏', 'warn');
    }
    
    btnTest.disabled = false;
    btnTest.textContent = 'üì¨ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ';
  });
  
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ—Å—Ç–∞ –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
  const btnTestAll = document.getElementById('btn-test-all');
  if(btnTestAll){
    btnTestAll.addEventListener('click', async () => {
      if(!window.pushManager) return;
      
      btnTestAll.disabled = true;
      btnTest.disabled = true;
      btnTestAll.textContent = 'üì§ –û—Ç–ø—Ä–∞–≤–∫–∞...';
      logStatus('–û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π...', 'info');
      
      // –ú–∞—Å—Å–∏–≤ —Ç–µ—Å—Ç–æ–≤—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
      const testNotifications = [
        {
          type: 'alert_water',
          delay: 0
        },
        {
          type: 'alert_humid',
          delay: 2000
        },
        {
          type: 'alert_high_temp',
          data: { temp: 32 },
          delay: 4000
        },
        {
          type: 'alert_low_temp',
          data: { temp: 8 },
          delay: 6000
        },
        {
          type: 'err_sensor_temp',
          delay: 8000
        }
      ];
      
      let successCount = 0;
      
      try {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
        for(const notif of testNotifications){
          await new Promise(resolve => setTimeout(resolve, notif.delay));
          
          try {
            const success = await window.pushManager.showGrowHubAlert(notif.type, notif.data || {});
            if(success) successCount++;
          } catch(err){
            console.error('[Notifications] Failed to send:', notif.type, err);
          }
        }
        
        logStatus(`–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ${successCount} –∏–∑ ${testNotifications.length} —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π`, 'success');
      } catch(err) {
        console.error('[Notifications] Test all error:', err);
        logStatus('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ—Å—Ç–æ–≤', 'warn');
      }
      
      btnTestAll.disabled = false;
      btnTest.disabled = false;
      btnTestAll.textContent = 'üîî –¢–µ—Å—Ç –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (5 —à—Ç—É–∫)';
    });
  }
  
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–µ–π —Ç–∏–ø–æ–≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
  alertToggles.querySelectorAll('input[type="checkbox"]').forEach(toggle => {
    toggle.addEventListener('change', saveAlertPreferences);
  });
  
  // –û–∂–∏–¥–∞–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ pushManager
  function waitForPushManager(){
    if(window.pushManager && window.pushManager.supported !== undefined){
      updateUI();
    } else {
      setTimeout(waitForPushManager, 100);
    }
  }
  
  waitForPushManager();
})();
</script>
</body>
</html>
