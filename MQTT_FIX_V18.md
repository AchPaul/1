# MQTT Publish Fix - GrowHub PWA

## –ü—Ä–æ–±–ª–µ–º–∞
–ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ MQTTManager –ø–µ—Ä–µ—Å—Ç–∞–ª–∏ —Ä–∞–±–æ—Ç–∞—Ç—å –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ (–æ—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–º–∞–Ω–¥) —Å –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤. –°–∏–º–ø—Ç–æ–º—ã:
- ‚úÖ –ß—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç–∞–µ—Ç (state –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è)
- ‚ùå –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–º–∞–Ω–¥ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç (–±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–µ "–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ")
- ‚ùå –ù–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

## –ü—Ä–∏—á–∏–Ω—ã
1. **–û—á–µ—Ä–µ–¥—å –ø—É–±–ª–∏–∫–∞—Ü–∏–π –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª–∞** - –∫–æ–º–∞–Ω–¥—ã –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∏—Å—å –î–û —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
2. **–°—Ç—Ä–æ–≥–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ connected** - –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∞ –≤—Å–µ –ø–æ–ø—ã—Ç–∫–∏ publish –¥–æ –ø–æ–ª–Ω–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
3. **SharedWorker –º–æ–∂–µ—Ç –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å—Å—è** –Ω–∞ —Å—Ç–∞—Ä—ã—Ö –º–æ–±–∏–ª—å–Ω—ã—Ö –±—Ä–∞—É–∑–µ—Ä–∞—Ö (Safari iOS < 16.4)
4. **–ú–µ–¥–ª–µ–Ω–Ω–æ–µ WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ** –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö (3G/4G)

## –†–µ—à–µ–Ω–∏–µ (v18)

### 1. –û—á–µ—Ä–µ–¥—å –ø—É–±–ª–∏–∫–∞—Ü–∏–π –≤ mqtt-worker.js
```javascript
let publishQueue = []; // –ù–∞–∫–∞–ø–ª–∏–≤–∞–µ–º –∫–æ–º–∞–Ω–¥—ã –¥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

function publish(key, value) {
  // –ï—Å–ª–∏ –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω—ã - –¥–æ–±–∞–≤–ª—è–µ–º –≤ –æ—á–µ—Ä–µ–¥—å
  if (!mqttClient || !mqttClient.connected) {
    publishQueue.push({ key, value });
    return false;
  }
  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—Ä–∞–∑—É –µ—Å–ª–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω—ã
  mqttClient.publish(topic, String(value), { qos: 0 });
  return true;
}

// –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—á–µ—Ä–µ–¥—å
mqttClient.on('connect', () => {
  if (publishQueue.length > 0) {
    publishQueue.forEach(({ key, value }) => {
      publish(key, value);
    });
    publishQueue = [];
  }
});
```

### 2. –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ mqtt-manager.js
```javascript
publish(key, value) {
  if (!this.worker || !this.worker.port) {
    console.error('[MQTT Manager] Worker not initialized');
    return false;
  }
  
  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–µ connected - worker —Å–∞–º –ø–æ—Å—Ç–∞–≤–∏—Ç –≤ –æ—á–µ—Ä–µ–¥—å
  try {
    this.worker.port.postMessage({
      type: 'publish',
      data: { key, value }
    });
    return true;
  } catch (error) {
    console.error('[MQTT Manager] Failed to send:', error);
    return false;
  }
}
```

### 3. –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –≤ app_optimized.js
```javascript
function publish(key, val){
  const success = mqttManager.publish(key, String(val));
  
  if (success) {
    flashPub(`${key}=${val}`);
  } else if (!connected) {
    flashPub(`${key}=${val} (–≤ –æ—á–µ—Ä–µ–¥–∏)`); // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —á—Ç–æ –∫–æ–º–∞–Ω–¥–∞ –ø—Ä–∏–Ω—è—Ç–∞
  }
  
  return success;
}
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –í–∞—Ä–∏–∞–Ω—Ç 1: –°—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
–û—Ç–∫—Ä–æ–π—Ç–µ `mqtt-debug.html` –Ω–∞ –ø—Ä–æ–±–ª–µ–º–Ω–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ:
```
https://your-pwa-url/mqtt-debug.html
```

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:**
- ‚úÖ SharedWorker –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è?
- ‚úÖ WebSocket –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è?
- ‚úÖ –°—Ç–∞—Ç—É—Å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è "connected"?
- ‚úÖ –¢–µ—Å—Ç–æ–≤–∞—è –ø—É–±–ª–∏–∫–∞—Ü–∏—è –ø—Ä–æ—Ö–æ–¥–∏—Ç?
- ‚úÖ –õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —É—Å–ø–µ—à–Ω—ã–µ publish?

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ö–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞
–ù–∞ –ª—é–±–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ PWA (F12 ‚Üí Console):
```javascript
// –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
console.log('mqttManager:', mqttManager);
console.log('Connected:', mqttManager?.isConnected());

// –¢–µ—Å—Ç–æ–≤–∞—è –ø—É–±–ª–∏–∫–∞—Ü–∏—è
mqttManager.publish('lig_pwm', 75);

// –ü—Ä–æ–≤–µ—Ä–∫–∞ SharedWorker
console.log('SharedWorker:', typeof SharedWorker !== 'undefined' ? 'OK' : 'NOT SUPPORTED');
```

### –í–∞—Ä–∏–∞–Ω—Ç 3: Service Worker –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—ç—à–∞:
1. –û—Ç–∫—Ä–æ–π—Ç–µ DevTools (F12)
2. Application ‚Üí Service Workers
3. –ù–∞–∂–º–∏—Ç–µ "Update" –∏–ª–∏ "Unregister"
4. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É (Ctrl+Shift+R)

## –û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –î–û (v17):
```
User: –ù–∞–∂–∏–º–∞–µ—Ç —Å–ª–∞–π–¥–µ—Ä lig_pwm ‚Üí 75
App:  –ü—Ä–æ–≤–µ—Ä—è–µ—Ç connected === true ‚Üí FALSE
App:  return; (–Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ—Ç)
UI:   –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ..." –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ
```

### –ü–û–°–õ–ï (v18):
```
User: –ù–∞–∂–∏–º–∞–µ—Ç —Å–ª–∞–π–¥–µ—Ä lig_pwm ‚Üí 75
App:  mqttManager.publish('lig_pwm', 75)
Worker: mqttClient.connected? NO ‚Üí publishQueue.push({lig_pwm: 75})
UI:   –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç "lig_pwm=75 (–≤ –æ—á–µ—Ä–µ–¥–∏)"
--- 2 —Å–µ–∫—É–Ω–¥—ã —Å–ø—É—Å—Ç—è ---
Worker: mqttClient.on('connect') ‚Üí –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—á–µ—Ä–µ–¥—å
Worker: publish('lig_pwm', 75) ‚Üí –£–°–ü–ï–•
UI:   –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç "‚úÖ –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ: lig_pwm=75"
ESP32: –ü–æ–ª—É—á–∞–µ—Ç –∫–æ–º–∞–Ω–¥—É —á–µ—Ä–µ–∑ MQTT
```

## –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –±—Ä–∞—É–∑–µ—Ä–æ–≤

| –ë—Ä–∞—É–∑–µ—Ä | SharedWorker | WebSocket | –°—Ç–∞—Ç—É—Å |
|---------|--------------|-----------|--------|
| Chrome 120+ | ‚úÖ | ‚úÖ | **–ü–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞** |
| Edge 120+ | ‚úÖ | ‚úÖ | **–ü–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞** |
| Safari 16.4+ | ‚úÖ | ‚úÖ | **–ü–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞** |
| Safari < 16.4 | ‚ùå | ‚úÖ | **Fallback needed** |
| Firefox 121+ | ‚úÖ* | ‚úÖ | **–†–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ HTTP(S)** |

*Firefox —Ç—Ä–µ–±—É–µ—Ç HTTPS –¥–ª—è SharedWorker (–Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å file://)

## –û—Ç–∫–∞—Ç –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö

–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫, –æ—Ç–∫–∞—Ç–∏—Ç–µ—Å—å –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â—É—é –≤–µ—Ä—Å–∏—é:
```javascript
// service-worker.js
const CACHE = 'gh-remote-v17'; // –ë—ã–ª–æ: 'gh-remote-v18'
```

–ò–ª–∏ –æ—á–∏—Å—Ç–∏—Ç–µ –∫—ç—à –±—Ä–∞—É–∑–µ—Ä–∞:
```
Chrome: Settings ‚Üí Privacy ‚Üí Clear browsing data
Safari: Develop ‚Üí Empty Caches
```

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (TODO)

1. **Fallback –±–µ–∑ SharedWorker** –¥–ª—è Safari < 16.4:
   ```javascript
   if (typeof SharedWorker === 'undefined') {
     // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–±—ã—á–Ω—ã–π Worker –∏–ª–∏ –ø—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
   }
   ```

2. **–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –æ—á–µ—Ä–µ–¥–∏** –≤ UI:
   ```html
   <div id="queue-indicator">üì§ –í –æ—á–µ—Ä–µ–¥–∏: 3 –∫–æ–º–∞–Ω–¥—ã</div>
   ```

3. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞** –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö:
   ```javascript
   if (!success) {
     setTimeout(() => publish(key, val), 2000);
   }
   ```

## Changelog

### v18 (09.12.2025)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ—á–µ—Ä–µ–¥—å –ø—É–±–ª–∏–∫–∞—Ü–∏–π –≤ mqtt-worker.js
- ‚úÖ –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ mqtt-manager.js
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å "(–≤ –æ—á–µ—Ä–µ–¥–∏)"
- ‚úÖ –°–æ–∑–¥–∞–Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ mqtt-debug.html
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ —Å publish –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö

### v17 (09.12.2025)
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è favicon
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç—Å—Ç—É–ø–æ–≤ telegram.html/time.html

### v16 (08.12.2025)
- –ú–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ MQTTManager + SharedWorker
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤ localStorage

---

**–ê–≤—Ç–æ—Ä –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** GitHub Copilot  
**–î–∞—Ç–∞:** 09.12.2025  
**–í–µ—Ä—Å–∏—è PWA:** v18
