<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>–¢–µ—Å—Ç Publish - GrowHub</title>
<style>
body{background:#000;color:#fff;font-family:monospace;padding:20px}
h1{color:#c900cc;text-align:center}
.test-box{background:#1a001a;border:2px solid #500078;border-radius:10px;padding:15px;margin:15px 0}
button{background:#500078;color:#fff;border:2px solid #c900cc;padding:10px 20px;border-radius:5px;cursor:pointer;margin:5px;font-size:16px}
button:active{background:#c900cc}
#log{background:#000;border:1px solid #500078;padding:10px;border-radius:5px;max-height:400px;overflow-y:auto;font-size:13px}
.log-entry{margin-bottom:5px}
.success{color:#4CAF50}
.error{color:#EF5350}
.info{color:#2196F3}
input{background:#1a001a;color:#fff;border:2px solid #500078;padding:8px;margin:5px;border-radius:5px;width:150px}
</style>
</head>
<body>
<h1>üß™ –¢–µ—Å—Ç MQTT Publish</h1>

<div class="test-box">
  <h3>–°—Ç–∞—Ç—É—Å: <span id="status">‚Äî</span></h3>
  <p>Config: <span id="config">‚Äî</span></p>
</div>

<div class="test-box">
  <h3>–ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç</h3>
  <button onclick="test('lig_pwm', 50)">–°–≤–µ—Ç 50%</button>
  <button onclick="test('lig_pwm', 100)">–°–≤–µ—Ç 100%</button>
  <button onclick="test('temp_day', 22)">–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ 22¬∞C</button>
  <button onclick="test('humgr_day', 60)">–í–ª–∞–∂–Ω–æ—Å—Ç—å 60%</button>
</div>

<div class="test-box">
  <h3>–ö–∞—Å—Ç–æ–º–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞</h3>
  <input id="key" placeholder="–∫–ª—é—á" value="lig_pwm">
  <input id="value" placeholder="–∑–Ω–∞—á–µ–Ω–∏–µ" value="75">
  <button onclick="customTest()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
</div>

<div class="test-box">
  <h3>–ñ—É—Ä–Ω–∞–ª</h3>
  <button onclick="document.getElementById('log').innerHTML=''">–û—á–∏—Å—Ç–∏—Ç—å</button>
  <div id="log"></div>
</div>

<script type="module">
import MQTTManager from './mqtt-manager.js';

const statusEl = document.getElementById('status');
const configEl = document.getElementById('config');
const logEl = document.getElementById('log');

let mqttManager = null;
let testCount = 0;

function log(msg, type = 'info') {
  const time = new Date().toLocaleTimeString();
  const entry = document.createElement('div');
  entry.className = `log-entry ${type}`;
  entry.textContent = `[${time}] ${msg}`;
  logEl.insertBefore(entry, logEl.firstChild);
  console.log(msg);
}

const cfg = (() => {
  try {
    const stored = localStorage.getItem('gh_remote_cfg_v1');
    return stored ? JSON.parse(stored) : null;
  } catch (e) {
    return null;
  }
})();

if (!cfg || !cfg.host || !cfg.port || !cfg.base) {
  statusEl.textContent = '‚ùå –ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ';
  configEl.innerHTML = '<a href="index.html" style="color:#c900cc">–ù–∞—Å—Ç—Ä–æ–∏—Ç—å</a>';
  log('‚ùå –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'error');
} else {
  statusEl.textContent = 'üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...';
  configEl.textContent = `${cfg.host}:${cfg.port}/${cfg.base}`;
  
  mqttManager = new MQTTManager();
  
  mqttManager.on('status', (status) => {
    statusEl.textContent = status === 'connected' ? '‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ' : 
                          status === 'connecting' ? 'üîÑ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...' : 
                          '‚ùå ' + status;
    log(`–°—Ç–∞—Ç—É—Å: ${status}`, status === 'connected' ? 'success' : 'info');
  });
  
  mqttManager.on('published', ({ key, value }) => {
    log(`‚úÖ –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ: ${key}=${value}`, 'success');
  });
  
  mqttManager.on('queued', ({ key, value }) => {
    log(`‚è≥ –í –æ—á–µ—Ä–µ–¥–∏: ${key}=${value}`, 'info');
  });
  
  mqttManager.on('error', (error) => {
    log(`‚ùå –û—à–∏–±–∫–∞: ${error.message || error}`, 'error');
  });
  
  log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è MQTT...', 'info');
  mqttManager.connect(cfg);
}

window.test = function(key, value) {
  if (!mqttManager) {
    log('‚ùå MQTT –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω', 'error');
    return;
  }
  
  testCount++;
  log(`üì§ –¢–µ—Å—Ç #${testCount}: ${key}=${value}`, 'info');
  
  const success = mqttManager.publish(key, value);
  if (!success) {
    log(`‚ö†Ô∏è publish() –≤–µ—Ä–Ω—É–ª false`, 'error');
  }
};

window.customTest = function() {
  const key = document.getElementById('key').value.trim();
  const value = document.getElementById('value').value.trim();
  
  if (!key || !value) {
    log('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∫–ª—é—á –∏ –∑–Ω–∞—á–µ–Ω–∏–µ', 'error');
    return;
  }
  
  window.test(key, value);
};
</script>
</body>
</html>
