# Исправления миграции MQTT (09.12.2025)

## Проблемы, которые были исправлены

### 1. SharedWorker не запускался (КРИТИЧНО)
**Проблема:** `new SharedWorker('mqtt-worker.js', { type: 'module' })` вызывал ошибку  
**Исправление:** Удалён параметр `{ type: 'module' }` из mqtt-manager.js  
**Статус:** ✅ Исправлено

### 2. Страница telegram.html не получала данные
**Проблема:** Использовался старый код с библиотекой Paho.MQTT вместо MQTTManager  
**Исправление:** Полностью переписан inline MQTT код на использование MQTTManager  
**Статус:** ✅ Исправлено

### 3. Страница time.html не получала данные
**Проблема:** Использовался старый код с прямым вызовом mqtt.connect()  
**Исправление:** Переписан на использование MQTTManager  
**Статус:** ✅ Исправлено

### 4. Отсутствовала обработка ошибок загрузки MQTT библиотеки
**Проблема:** importScripts() мог падать без логирования  
**Исправление:** Добавлен try-catch и проверка `typeof mqtt !== 'undefined'`  
**Статус:** ✅ Исправлено

### 5. Функция publish в worker работала некорректно
**Проблема:** Не было проверки _setBase, отсутствовал параметр qos  
**Исправление:** Добавлена полная обработка ошибок и логирование  
**Статус:** ✅ Исправлено

## Файлы, которые были изменены

1. **mqtt-manager.js**
   - Удалён `type: 'module'` из SharedWorker
   - Добавлена обработка ошибок worker
   - Добавлена задержка перед запросом состояния

2. **mqtt-worker.js**
   - Обёрнут importScripts в try-catch
   - Добавлена проверка загрузки библиотеки
   - Улучшена функция publish
   - Добавлено детальное логирование

3. **telegram.html**
   - Переписан inline MQTT код
   - Убран старый Paho.MQTT клиент
   - Добавлен MQTTManager

4. **time.html**
   - Переписан inline MQTT код
   - Убран старый mqtt.connect()
   - Добавлен MQTTManager

5. **app_optimized.js**
   - Добавлено логирование создания MQTTManager
   - Добавлено логирование подключения

6. **service-worker.js**
   - Обновлена версия кэша: v14 → v16

## Как проверить работу

### Шаг 1: Очистить кэш браузера
```
F12 → Application → Storage → Clear site data
```

### Шаг 2: Открыть консоль браузера (F12)

### Шаг 3: Открыть telegram.html

**Ожидаемые логи:**
```
[Telegram] Initializing MQTTManager
[MQTT Manager] Connecting to: ...
[MQTT Worker] Loading...
[MQTT Worker] MQTT library loaded, version: OK
[MQTT Worker] connect() called with config: {...}
[MQTT Worker] Connecting to: wss://...
[Telegram] MQTT status: connected
[Telegram] State received: {...}
```

**Результат:** Статус должен измениться с "Загрузка..." на "Включено" или "Выключено"

### Шаг 4: Проверить другие страницы

- **index.html** - главная страница с настройками
- **state.html** - текущее состояние датчиков
- **settings.html** - управление параметрами
- **time.html** - настройка времени
- **profile.html** - выбор растения

Все страницы должны показывать актуальные данные через 1-2 секунды после открытия.

## Troubleshooting

### Проблема: "MQTT library not loaded!"
**Решение:** 
- Проверьте интернет-соединение
- Откройте https://unpkg.com/mqtt@5.3.5/dist/mqtt.min.js в браузере
- Если не загружается - используйте локальную копию библиотеки

### Проблема: "Failed to construct 'SharedWorker'"
**Решение:**
- Используйте Chrome/Edge (Firefox не поддерживает SharedWorker при file://)
- Убедитесь, что файлы открыты через HTTP-сервер, а не напрямую

### Проблема: Статус "Подключение..." зависает
**Решение:**
- Проверьте настройки MQTT на главной странице (index.html)
- Убедитесь, что брокер доступен: `telnet mqtt.growhub.ru 8884`
- Проверьте firewall и антивирус

### Проблема: Данные не обновляются
**Решение:**
- Проверьте, что ESP32 публикует данные в топик `<base>/state/json`
- Откройте консоль и посмотрите логи `[MQTT Worker] message received`
- Проверьте, что формат JSON корректный

## Версии кэша Service Worker

- v13 - Первая версия с MQTT оптимизацией (неверные пути)
- v14 - Исправлены пути файлов
- v15 - Исправлен SharedWorker
- **v16** - Исправлены telegram.html и time.html (текущая)

При любых изменениях инкрементируйте версию кэша для принудительного обновления.

## Статус миграции: ✅ ЗАВЕРШЕНА

Все страницы теперь используют единую архитектуру Shared Worker через MQTTManager.
