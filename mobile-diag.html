<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>–ú–æ–±–∏–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ - GrowHub</title>
<style>
body{background:#000;color:#fff;font-family:monospace;padding:10px;font-size:14px}
h1{color:#c900cc;text-align:center;font-size:20px;margin-bottom:15px}
.box{background:#1a001a;border:2px solid #500078;border-radius:8px;padding:12px;margin-bottom:12px}
.box h3{color:#b65ee5;font-size:16px;margin-bottom:8px}
.info{display:grid;grid-template-columns:auto 1fr;gap:5px 10px;font-size:13px}
.info dt{color:#c4a1c7}
.info dd{color:#fff;font-weight:bold;word-break:break-all}
.status{padding:10px;border-radius:5px;margin-bottom:10px;text-align:center;font-weight:bold;font-size:16px}
.ok{background:#1B5E20;border:2px solid #4CAF50}
.err{background:#B71C1C;border:2px solid #F44336}
.warn{background:#E65100;border:2px solid #FF9800}
button{background:#500078;color:#fff;border:2px solid #c900cc;padding:10px 15px;border-radius:5px;cursor:pointer;margin:5px;font-size:14px;width:calc(50% - 10px)}
button:active{background:#c900cc}
.log{background:#000;border:1px solid #500078;padding:8px;border-radius:5px;max-height:250px;overflow-y:auto;font-size:12px}
.log div{margin-bottom:3px}
.success{color:#4CAF50}
.error{color:#EF5350}
.info{color:#2196F3}
</style>
</head>
<body>
<h1>üì± –ú–æ–±–∏–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</h1>

<div id="main-status" class="status warn">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>

<div class="box">
  <h3>–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</h3>
  <div class="info">
    <dt>UserAgent:</dt><dd id="ua" style="font-size:11px">‚Äî</dd>
    <dt>–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞:</dt><dd id="platform">‚Äî</dd>
    <dt>Online:</dt><dd id="online">‚Äî</dd>
  </div>
</div>

<div class="box">
  <h3>–ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π</h3>
  <div class="info">
    <dt>SharedWorker:</dt><dd id="sw">‚Äî</dd>
    <dt>WebSocket:</dt><dd id="ws">‚Äî</dd>
    <dt>ServiceWorker:</dt><dd id="serv">‚Äî</dd>
    <dt>LocalStorage:</dt><dd id="ls">‚Äî</dd>
  </div>
</div>

<div class="box">
  <h3>MQTT –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è</h3>
  <div class="info">
    <dt>–•–æ—Å—Ç:</dt><dd id="host">‚Äî</dd>
    <dt>–ü–æ—Ä—Ç:</dt><dd id="port">‚Äî</dd>
    <dt>–ü—Ä–æ—Ç–æ–∫–æ–ª:</dt><dd id="proto">‚Äî</dd>
    <dt>URL:</dt><dd id="url" style="font-size:11px">‚Äî</dd>
  </div>
</div>

<div class="box">
  <h3>–î–µ–π—Å—Ç–≤–∏—è</h3>
  <button onclick="testConnection()">üîÑ –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</button>
  <button onclick="clearAll()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
  <button onclick="testPublish()">üì§ –¢–µ—Å—Ç publish</button>
  <button onclick="openFullDiag()">üî¨ –ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</button>
</div>

<div class="box">
  <h3>–ñ—É—Ä–Ω–∞–ª (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 10)</h3>
  <div id="log" class="log"></div>
</div>

<script type="module">
import MQTTManager from './mqtt-manager.js';

const mainStatus = document.getElementById('main-status');
const logEl = document.getElementById('log');
let logCount = 0;
let mqttManager = null;

function log(msg, type = 'info') {
  logCount++;
  const entry = document.createElement('div');
  entry.className = type;
  entry.textContent = `${logCount}. ${msg}`;
  logEl.insertBefore(entry, logEl.firstChild);
  while (logEl.children.length > 10) logEl.removeChild(logEl.lastChild);
  console.log(`[Mobile] ${msg}`);
}

// –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
document.getElementById('ua').textContent = navigator.userAgent;
document.getElementById('platform').textContent = navigator.platform;
document.getElementById('online').textContent = navigator.onLine ? '‚úÖ –û–Ω–ª–∞–π–Ω' : '‚ùå –û—Ñ–ª–∞–π–Ω';

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π
document.getElementById('sw').textContent = typeof SharedWorker !== 'undefined' ? '‚úÖ' : '‚ùå –ù–ï –ü–û–î–î–ï–†–ñ–ò–í–ê–ï–¢–°–Ø';
document.getElementById('ws').textContent = typeof WebSocket !== 'undefined' ? '‚úÖ' : '‚ùå';
document.getElementById('serv').textContent = 'serviceWorker' in navigator ? '‚úÖ' : '‚ùå';
document.getElementById('ls').textContent = typeof localStorage !== 'undefined' ? '‚úÖ' : '‚ùå';

if (typeof SharedWorker === 'undefined') {
  mainStatus.className = 'status err';
  mainStatus.textContent = '‚ùå SharedWorker –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è';
  log('SharedWorker –ù–ï –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ', 'error');
  log('–¢—Ä–µ–±—É–µ—Ç—Å—è Chrome 120+ –∏–ª–∏ –¥—Ä—É–≥–æ–π –±—Ä–∞—É–∑–µ—Ä', 'error');
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
let cfg = null;
try {
  const stored = localStorage.getItem('gh_remote_cfg_v1');
  cfg = stored ? JSON.parse(stored) : null;
} catch (e) {
  log('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: ' + e.message, 'error');
}

if (!cfg || !cfg.host || !cfg.port) {
  mainStatus.className = 'status err';
  mainStatus.textContent = '‚ùå –ù–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏';
  log('MQTT –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω', 'error');
  document.getElementById('host').innerHTML = '<a href="index.html" style="color:#c900cc">–ù–∞—Å—Ç—Ä–æ–∏—Ç—å</a>';
} else {
  document.getElementById('host').textContent = cfg.host;
  document.getElementById('port').textContent = cfg.port;
  
  const tlsPorts = [8883, 8884, 8885, 443];
  const proto = tlsPorts.includes(parseInt(cfg.port)) ? 'wss' : 'ws';
  document.getElementById('proto').textContent = proto + '://';
  document.getElementById('proto').style.color = proto === 'wss' ? '#4CAF50' : '#FFA726';
  
  const url = `${proto}://${cfg.host}:${cfg.port}/mqtt`;
  document.getElementById('url').textContent = url;
  
  log('–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞', 'success');
  log(`–ü—Ä–æ—Ç–æ–∫–æ–ª: ${proto}://`, 'info');
  
  if (typeof SharedWorker !== 'undefined') {
    initMQTT();
  }
}

function initMQTT() {
  if (!cfg) return;
  
  log('–°–æ–∑–¥–∞–Ω–∏–µ MQTTManager...', 'info');
  mainStatus.className = 'status warn';
  mainStatus.textContent = 'üîÑ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';
  
  try {
    mqttManager = new MQTTManager();
    log('MQTTManager —Å–æ–∑–¥–∞–Ω', 'success');
    
    mqttManager.on('status', (status) => {
      log(`–°—Ç–∞—Ç—É—Å: ${status}`, status === 'connected' ? 'success' : status === 'error' ? 'error' : 'info');
      
      if (status === 'connected') {
        mainStatus.className = 'status ok';
        mainStatus.textContent = '‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
      } else if (status === 'error') {
        mainStatus.className = 'status err';
        mainStatus.textContent = '‚ùå –û—à–∏–±–∫–∞';
      } else {
        mainStatus.className = 'status warn';
        mainStatus.textContent = 'üîÑ ' + status;
      }
    });
    
    mqttManager.on('state', (state) => {
      log('–ü–æ–ª—É—á–µ–Ω–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ', 'success');
    });
    
    mqttManager.on('published', ({ key, value }) => {
      log(`‚úÖ –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ: ${key}=${value}`, 'success');
    });
    
    mqttManager.on('queued', ({ key, value }) => {
      log(`‚è≥ –í –æ—á–µ—Ä–µ–¥–∏: ${key}=${value}`, 'info');
    });
    
    mqttManager.on('error', (error) => {
      log(`‚ùå –û—à–∏–±–∫–∞: ${error.message || error}`, 'error');
    });
    
    log('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±—Ä–æ–∫–µ—Ä—É...', 'info');
    mqttManager.connect(cfg);
    
  } catch (e) {
    log(`‚ùå –ò—Å–∫–ª—é—á–µ–Ω–∏–µ: ${e.message}`, 'error');
    mainStatus.className = 'status err';
    mainStatus.textContent = '‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏';
  }
}

window.testConnection = function() {
  log('–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...', 'info');
  if (mqttManager) {
    mqttManager.disconnect();
    setTimeout(() => initMQTT(), 1000);
  } else {
    initMQTT();
  }
};

window.testPublish = function() {
  if (!mqttManager) {
    log('‚ùå MQTT –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω', 'error');
    return;
  }
  const val = Math.floor(Math.random() * 100);
  log(`üì§ –û—Ç–ø—Ä–∞–≤–∫–∞: lig_pwm=${val}`, 'info');
  mqttManager.publish('lig_pwm', val);
};

window.clearAll = function() {
  if (confirm('–£–¥–∞–ª–∏—Ç—å –í–°–ï –¥–∞–Ω–Ω—ã–µ (–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è, –∫—ç—à)?')) {
    localStorage.clear();
    log('üóëÔ∏è –í—Å—ë —É–¥–∞–ª–µ–Ω–æ', 'success');
    setTimeout(() => location.reload(), 1000);
  }
};

window.openFullDiag = function() {
  location.href = 'mqtt-debug.html';
};

// –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
setInterval(() => {
  const online = navigator.onLine;
  document.getElementById('online').textContent = online ? '‚úÖ –û–Ω–ª–∞–π–Ω' : '‚ùå –û—Ñ–ª–∞–π–Ω';
  if (!online) {
    log('‚ö†Ô∏è –ù–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞', 'error');
  }
}, 5000);
</script>
</body>
</html>
