<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Chrome Fix - GrowHub</title>
<style>
body{background:#000;color:#fff;font-family:monospace;padding:20px;max-width:800px;margin:0 auto}
h1{color:#c900cc;text-align:center;font-size:28px}
h2{color:#b65ee5;font-size:22px;margin-top:30px}
.problem{background:#3d0000;border:2px solid #ff4444;border-radius:10px;padding:20px;margin:20px 0}
.solution{background:#003d00;border:2px solid #44ff44;border-radius:10px;padding:20px;margin:20px 0}
.warning{background:#3d3000;border:2px solid #ffaa44;border-radius:10px;padding:15px;margin:15px 0}
code{background:#1a001a;color:#c900cc;padding:3px 8px;border-radius:3px;font-size:14px}
pre{background:#1a001a;border:1px solid #500078;padding:15px;border-radius:5px;overflow-x:auto}
ul{line-height:1.8}
a{color:#c900cc;text-decoration:none}
a:hover{text-decoration:underline}
.btn{background:#500078;color:#fff;border:2px solid #c900cc;padding:12px 30px;border-radius:5px;cursor:pointer;margin:10px 5px;font-size:16px;display:inline-block}
.btn:hover{background:#c900cc}
</style>
</head>
<body>
<h1>üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å Chrome</h1>

<div class="problem">
<h2>‚ùå –ü—Ä–æ–±–ª–µ–º–∞</h2>
<p><strong>Chrome –±–ª–æ–∫–∏—Ä—É–µ—Ç WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ!</strong></p>
<ul>
<li>–°—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è, –Ω–æ MQTT –Ω–µ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è</li>
<li>–°—Ç–∞—Ç—É—Å –≤—Å—ë –≤—Ä–µ–º—è "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ..." –∏–ª–∏ "–û—à–∏–±–∫–∞"</li>
<li>–í –¥—Ä—É–≥–∏—Ö –±—Ä–∞—É–∑–µ—Ä–∞—Ö —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ</li>
<li>–ü—Ä–æ–±–ª–µ–º–∞ –ù–ï –≤ —Ç–µ–ª–µ—Ñ–æ–Ω–µ, –∞ –≤ –±—Ä–∞—É–∑–µ—Ä–µ Chrome</li>
</ul>
</div>

<h2>üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</h2>

<div class="warning">
<p><strong>–û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å Chrome (F12 ‚Üí Console) –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:</strong></p>
<pre>
‚ùå Mixed Content: The page at 'https://...' was loaded over HTTPS, 
   but attempted to connect to the insecure WebSocket endpoint 'ws://...'

‚ùå WebSocket connection failed: wss://broker:8883/mqtt

‚ùå SSL handshake failed
</pre>
</div>

<h2>‚úÖ –†–µ—à–µ–Ω–∏–µ (v20)</h2>

<div class="solution">
<p><strong>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞:</strong></p>
<pre>
// –ë–´–õ–û (v19 –∏ —Ä–∞–Ω–µ–µ):
const url = `wss://${host}:${port}/mqtt`; // ‚ùå –í—Å–µ–≥–¥–∞ wss://

// –°–¢–ê–õ–û (v20):
const tlsPorts = [8883, 8884, 8885, 443];
const protocol = tlsPorts.includes(port) ? 'wss' : 'ws';
const url = `${protocol}://${host}:${port}/mqtt`; // ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª
</pre>

<p><strong>–¢–µ–ø–µ—Ä—å:</strong></p>
<ul>
<li>–ü–æ—Ä—Ç <code>8883</code> ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ—Ç <code>wss://</code> (TLS)</li>
<li>–ü–æ—Ä—Ç <code>1883</code> ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ—Ç <code>ws://</code> (plain)</li>
<li>–ü–æ—Ä—Ç <code>8884</code> ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ—Ç <code>wss://</code> (TLS)</li>
<li>–ü–æ—Ä—Ç <code>443</code> ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ—Ç <code>wss://</code> (TLS)</li>
</ul>
</div>

<h2>üß™ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h2>

<p><strong>–®–∞–≥ 1:</strong> –û—á–∏—Å—Ç–∏—Ç–µ –∫—ç—à –±—Ä–∞—É–∑–µ—Ä–∞</p>
<pre>
Chrome: Ctrl+Shift+Delete ‚Üí –û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à
–ò–ª–∏: Ctrl+Shift+R (–ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞)
</pre>

<p><strong>–®–∞–≥ 2:</strong> –û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏</p>
<a href="mqtt-debug.html" class="btn">üìä –û—Ç–∫—Ä—ã—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É</a>

<p><strong>–®–∞–≥ 3:</strong> –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–æ—Ç–æ–∫–æ–ª</p>
<div class="warning">
<p>–í —Ä–∞–∑–¥–µ–ª–µ "–°—Ç–∞—Ç—É—Å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è" –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:</p>
<ul>
<li><strong>–ü—Ä–æ—Ç–æ–∫–æ–ª:</strong> üîí wss:// (TLS) - –µ—Å–ª–∏ –ø–æ—Ä—Ç 8883/8884</li>
<li><strong>–ü—Ä–æ—Ç–æ–∫–æ–ª:</strong> üîì ws:// (plain) - –µ—Å–ª–∏ –ø–æ—Ä—Ç 1883</li>
<li><strong>URL –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:</strong> –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∞–¥—Ä–µ—Å —Å –Ω—É–∂–Ω—ã–º –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–º</li>
</ul>
</div>

<h2>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ MQTT –±—Ä–æ–∫–µ—Ä–∞</h2>

<div class="warning">
<p><strong>–ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –ø–æ—Ä—Ç 1883 (ws://):</strong></p>
<ul>
<li>‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π —Å–µ—Ç–∏ –±–µ–∑ SSL</li>
<li>‚ö†Ô∏è Chrome –º–æ–∂–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å mixed content –µ—Å–ª–∏ PWA –æ—Ç–∫—Ä—ã—Ç–æ —á–µ—Ä–µ–∑ HTTPS</li>
<li>üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ—Ä—Ç 8883 (wss://) –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏</li>
</ul>

<p><strong>–ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –ø–æ—Ä—Ç 8883 (wss://):</strong></p>
<ul>
<li>‚úÖ –ü–æ–ª–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (TLS/SSL)</li>
<li>‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –∏–∑ –ª—é–±–æ–π —Ç–æ—á–∫–∏ –º–∏—Ä–∞</li>
<li>‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –Ω–∞ –±—Ä–æ–∫–µ—Ä–µ</li>
<li>üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Let's Encrypt –¥–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞</li>
</ul>
</div>

<h2>üîê –°–∞–º–æ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã</h2>

<p>–ï—Å–ª–∏ –≤–∞—à MQTT –±—Ä–æ–∫–µ—Ä –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–∞–º–æ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç:</p>
<pre>
mqttClient = mqtt.connect(url, {
  rejectUnauthorized: false // ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –≤ v20
});
</pre>

<div class="warning">
<p><strong>‚ö†Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:</strong></p>
<p><code>rejectUnauthorized: false</code> –æ—Ç–∫–ª—é—á–∞–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫—É —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ –≤ —Ç–µ—Å—Ç–æ–≤–æ–π —Å—Ä–µ–¥–µ –∏–ª–∏ –ª–æ–∫–∞–ª—å–Ω–æ–π —Å–µ—Ç–∏. –î–ª—è production –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–∞–ª–∏–¥–Ω—ã–π SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç!</p>
</div>

<h2>üêõ –û—Ç–ª–∞–¥–∫–∞ –≤ –∫–æ–Ω—Å–æ–ª–∏</h2>

<p>–û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å Chrome (F12) –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:</p>
<pre>
// –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
const cfg = JSON.parse(localStorage.getItem('gh_remote_cfg_v1'));
console.log('Config:', cfg);

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞
const tlsPorts = [8883, 8884, 8885, 443];
const port = parseInt(cfg.port);
const protocol = tlsPorts.includes(port) ? 'wss' : 'ws';
console.log('Protocol:', protocol);
console.log('URL:', `${protocol}://${cfg.host}:${cfg.port}/mqtt`);

// –ü—Ä–æ–≤–µ—Ä–∫–∞ SharedWorker
console.log('SharedWorker:', typeof SharedWorker !== 'undefined');
</pre>

<h2>üìã –ß–µ–∫–ª–∏—Å—Ç –ø—Ä–æ–±–ª–µ–º</h2>

<table border="1" cellpadding="10" style="border-collapse:collapse;width:100%;color:#fff">
<tr style="background:#500078">
<th>–ü—Ä–æ–±–ª–µ–º–∞</th>
<th>–ü—Ä–∏—á–∏–Ω–∞</th>
<th>–†–µ—à–µ–Ω–∏–µ</th>
</tr>
<tr>
<td>Mixed content error</td>
<td>PWA —á–µ—Ä–µ–∑ HTTPS, –Ω–æ MQTT —á–µ—Ä–µ–∑ ws://</td>
<td>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ wss:// (–ø–æ—Ä—Ç 8883)</td>
</tr>
<tr>
<td>WebSocket failed</td>
<td>–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª</td>
<td>v20 –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ—Ç –ø—Ä–æ—Ç–æ–∫–æ–ª</td>
</tr>
<tr>
<td>SSL handshake failed</td>
<td>–°–∞–º–æ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç</td>
<td>rejectUnauthorized: false (—É–∂–µ –≤ v20)</td>
</tr>
<tr>
<td>Connection refused</td>
<td>–ë—Ä–æ–∫–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω</td>
<td>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ mosquitto –Ω–∞ ESP32/—Å–µ—Ä–≤–µ—Ä–µ</td>
</tr>
<tr>
<td>Connection timeout</td>
<td>Firewall –±–ª–æ–∫–∏—Ä—É–µ—Ç</td>
<td>–û—Ç–∫—Ä–æ–π—Ç–µ –ø–æ—Ä—Ç—ã 1883/8883</td>
</tr>
</table>

<h2>üöÄ –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –≤ v20</h2>

<ul>
<li>‚úÖ –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ (ws:// vs wss://)</li>
<li>‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–∞–º–æ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã—Ö —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤</li>
<li>‚úÖ –£–≤–µ–ª–∏—á–µ–Ω —Ç–∞–π–º–∞—É—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –¥–æ 10 —Å–µ–∫—É–Ω–¥</li>
<li>‚úÖ –£–≤–µ–ª–∏—á–µ–Ω keepalive –¥–æ 30 —Å–µ–∫—É–Ω–¥</li>
<li>‚úÖ –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫</li>
<li>‚úÖ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–æ—Ç–æ–∫–æ–ª –∏ URL</li>
</ul>

<div style="text-align:center;margin-top:40px">
<a href="index.html" class="btn">üè† –ì–ª–∞–≤–Ω–∞—è</a>
<a href="mqtt-debug.html" class="btn">üî¨ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</a>
<a href="test-publish.html" class="btn">üß™ –¢–µ—Å—Ç Publish</a>
</div>

<footer style="text-align:center;margin-top:50px;color:#666;font-size:12px">
<p>GrowHub PWA v20 - Chrome WebSocket Fix</p>
<p>09.12.2025</p>
</footer>
</body>
</html>
